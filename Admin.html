<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFC Admin</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0b1220; color: #e5e7eb; padding: 24px; }
    h1 { color: #a78bfa; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .card { background: #0f172a; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; margin: 10px 0; }
    input, select { padding: 10px; border-radius: 8px; border: 1px solid #1f2937; background: #060b16; color: #e5e7eb; }
    button { padding: 10px 14px; border: none; border-radius: 8px; background: #2563eb; color: #fff; cursor: pointer; }
    button:hover { background: #1d4ed8; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 6px; border-bottom: 1px solid #1f2937; }
    th { text-align: left; color: #93c5fd; }
    .danger { background: #ef4444; }
    .ghost { background: transparent; border: 1px dashed #334155; color: #cbd5e1; }
    .muted { color: #94a3b8; font-size: 14px; }
    a { color: #93c5fd; }
    code { color: #93c5fd; }
  </style>
</head>
<body>
  <h1>üîê NFC Admin</h1>
  <p class="muted">Manage allowed NFC tokens, redirect behavior, enroll badges by tap, and set a PIN fallback. Open <a href="NFCLogin.html">NFCLogin.html</a> to test.</p>

  <div class="card">
    <h3>Configuration</h3>
    <div class="row">
      <label>Redirect URL&nbsp;<input id="redirectUrl" placeholder="Warehousesystem.html" /></label>
      <label>Case Sensitive&nbsp;
        <select id="caseSensitive">
          <option value="true">true</option>
          <option value="false">false</option>
        </select>
      </label>
      <button id="saveCfg">Save Config</button>
    </div>
    <p id="cfgMsg" class="muted"></p>
  </div>

  <div class="card">
    <h3>Enroll Badge by Tap (Web NFC)</h3>
    <p class="muted">Generate a token and write it to an NFC badge. After writing, it‚Äôs added to the allowed list automatically.</p>
    <div class="row">
      <input id="enrollToken" placeholder="Token to write (e.g., USER_1234)" style="min-width:260px" />
      <button id="genToken" class="ghost">Generate</button>
      <button id="writeBadge">Write to Badge</button>
      <button id="readBadge" class="ghost">Read Badge</button>
    </div>
    <p id="enrollMsg" class="muted"></p>
  </div>

  <div class="card">
    <h3>Allowed Tokens</h3>
    <div class="row">
      <input id="newToken" placeholder="Enter new allowed token..." />
      <button id="addToken">Add Token</button>
      <button id="export" class="ghost">Export JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button id="import" class="ghost">Import JSON</button>
    </div>
    <table>
      <thead><tr><th>Token</th><th style="width:120px">Actions</th></tr></thead>
      <tbody id="tokenRows"></tbody>
    </table>
  </div>

  <div class="card">
    <h3>PIN Fallback</h3>
    <p class="muted">Add one or more PINs as emergency access. PINs are stored as <em>SHA‚Äë256 hashes</em> in this browser‚Äôs localStorage.</p>
    <div class="row">
      <input id="pinLabel" placeholder="Label (e.g., User123)" />
      <input id="pinPlain" type="password" placeholder="New PIN" />
      <button id="addPin">Add PIN</button>
    </div>
    <table>
      <thead><tr><th>Label</th><th>Hash (first 12)</th><th style="width:120px">Actions</th></tr></thead>
      <tbody id="pinRows"></tbody>
    </table>
    <div class="row">
      <button id="wipeAll" class="danger">Wipe All Config</button>
    </div>
  </div>

<script>
const STORAGE_KEY = "nfcAuthCfg.v1";

function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function loadCfg(){
  try {
    const cfg = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
    if (!Array.isArray(cfg.tokens)) cfg.tokens = [];
    if (!Array.isArray(cfg.pins)) cfg.pins = []; // [{label, hash}]
    if (typeof cfg.redirectUrl !== "string") cfg.redirectUrl = "Warehousesystem.html";
    if (typeof cfg.caseSensitive !== "boolean") cfg.caseSensitive = true;
    return cfg;
  } catch(e){
    return { tokens: [], pins: [], redirectUrl: "Warehousesystem.html", caseSensitive: true };
  }
}
function saveCfg(cfg){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg)); }

function render(){
  const cfg = loadCfg();
  document.getElementById("redirectUrl").value = cfg.redirectUrl || "Warehousesystem.html";
  document.getElementById("caseSensitive").value = String(cfg.caseSensitive);

  // tokens
  const tbodyT = document.getElementById("tokenRows");
  tbodyT.innerHTML = "";
  cfg.tokens.forEach((t, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = '<td><code>'+escapeHtml(t)+'</code></td>' +
                   '<td><button data-i="'+i+'" class="danger">Delete</button></td>';
    tbodyT.appendChild(tr);
  });
  tbodyT.querySelectorAll("button.danger").forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.getAttribute("data-i"));
      const cfg = loadCfg();
      cfg.tokens.splice(idx,1);
      saveCfg(cfg); render();
    });
  });

  // pins
  const tbodyP = document.getElementById("pinRows");
  tbodyP.innerHTML = "";
  (cfg.pins || []).forEach((p, i) => {
    const h12 = (p.hash || "").slice(0,12);
    const tr = document.createElement("tr");
    tr.innerHTML = '<td>'+escapeHtml(p.label || "")+'</td>' +
                   '<td><code>'+escapeHtml(h12)+'</code></td>' +
                   '<td><button data-i="'+i+'" class="danger">Delete</button></td>';
    tbodyP.appendChild(tr);
  });
  tbodyP.querySelectorAll("button.danger").forEach(btn => {
    btn.addEventListener("click", () => {
      const idx = Number(btn.getAttribute("data-i"));
      const cfg = loadCfg();
      cfg.pins.splice(idx,1);
      saveCfg(cfg); render();
    });
  });
}

async function sha256Hex(input){
  const enc = new TextEncoder().encode(input);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  const arr = Array.from(new Uint8Array(buf));
  return arr.map(b => b.toString(16).padStart(2,'0')).join('');
}

document.getElementById("addPin").addEventListener("click", async () => {
  const label = (document.getElementById("pinLabel").value || "").trim();
  const pin = (document.getElementById("pinPlain").value || "").trim();
  if (!label || !pin){ alert("Enter a label and PIN."); return; }
  const hash = await sha256Hex(pin);
  const cfg = loadCfg();
  (cfg.pins ||= []);
  cfg.pins.push({ label, hash });
  saveCfg(cfg);
  document.getElementById("pinLabel").value = "";
  document.getElementById("pinPlain").value = "";
  render();
});

// Enroll by Tap
function genToken(){
  return "USER-" + ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
}
document.getElementById("genToken").addEventListener("click", () => {
  document.getElementById("enrollToken").value = genToken();
});
document.getElementById("writeBadge").addEventListener("click", async () => {
  const msg = document.getElementById("enrollMsg");
  const token = (document.getElementById("enrollToken").value || "").trim();
  if (!token){ msg.textContent = "Enter or generate a token first."; return; }
  if (!("NDEFReader" in window)){ msg.textContent = "Web NFC not supported. Use Chrome on Android over HTTPS."; return; }
  try {
    const ndef = new NDEFReader();
    await ndef.write({ records: [ { recordType: "text", data: token } ] });
    msg.textContent = "Wrote token to badge. Adding to allowed list...";
    const cfg = loadCfg();
    if (!cfg.tokens.includes(token)) cfg.tokens.push(token);
    saveCfg(cfg);
    render();
    msg.textContent = "Done! Badge written and token added.";
  } catch (e) {
    msg.textContent = "Write failed: " + (e.message || e);
  }
});
document.getElementById("readBadge").addEventListener("click", async () => {
  const msg = document.getElementById("enrollMsg");
  if (!("NDEFReader" in window)){ msg.textContent = "Web NFC not supported. Use Chrome on Android over HTTPS."; return; }
  try {
    const ndef = new NDEFReader();
    await ndef.scan();
    msg.textContent = "Hold the badge near the device...";
    ndef.onreading = (event) => {
      const dec = new TextDecoder();
      let token = "";
      for (const rec of event.message.records){
        if (rec.recordType === "text"){ token = dec.decode(rec.data); break; }
      }
      if (!token){ msg.textContent = "No text record found on badge."; return; }
      document.getElementById("enrollToken").value = token.trim();
      msg.textContent = "Read token from badge.";
    };
  } catch(e) {
    msg.textContent = "Read failed: " + (e.message || e);
  }
});

document.getElementById("addToken").addEventListener("click", () => {
  const v = document.getElementById("newToken").value.trim();
  if (!v) return;
  const cfg = loadCfg();
  if (!cfg.tokens.includes(v)) cfg.tokens.push(v);
  saveCfg(cfg);
  document.getElementById("newToken").value = "";
  render();
});

document.getElementById("saveCfg").addEventListener("click", () => {
  const cfg = loadCfg();
  cfg.redirectUrl = document.getElementById("redirectUrl").value.trim() || "Warehousesystem.html";
  cfg.caseSensitive = document.getElementById("caseSensitive").value === "true";
  saveCfg(cfg);
  const msg = document.getElementById("cfgMsg");
  msg.textContent = "Saved.";
  setTimeout(() => msg.textContent = "", 1200);
});

document.getElementById("export").addEventListener("click", () => {
  const cfg = loadCfg();
  const blob = new Blob([JSON.stringify(cfg, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "nfc-auth-config.json"; a.click();
});

document.getElementById("import").addEventListener("click", () => {
  document.getElementById("importFile").click();
});
document.getElementById("importFile").addEventListener("change", e => {
  const f = e.target.files && e.target.files[0];
  if (!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const cfg = JSON.parse(reader.result);
      if (!cfg || typeof cfg !== "object" || !Array.isArray(cfg.tokens)) throw new Error("Invalid file");
      // ensure pins array exists
      if (!Array.isArray(cfg.pins)) cfg.pins = [];
      if (typeof cfg.redirectUrl !== "string") cfg.redirectUrl = "Warehousesystem.html";
      if (typeof cfg.caseSensitive !== "boolean") cfg.caseSensitive = true;
      saveCfg(cfg); render();
    } catch (err) {
      alert("Import failed: " + (err.message || err));
    }
  };
  reader.readAsText(f);
  e.target.value = "";
});

document.getElementById("wipeAll").addEventListener("click", () => {
  if (!confirm("This will erase tokens, PINs, and config on this device. Continue?")) return;
  localStorage.removeItem(STORAGE_KEY);
  render();
});

render();
</script>
</body>
</html>
